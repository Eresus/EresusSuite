<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <title>$(pageTitle)</title>
  <meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
  <meta http-equiv="Cache-control" content="no-cache; must-revalidate">
  <link rel="StyleSheet" href="$(httpRoot)core/dlg/dialogs.css" type="text/css">
  <script src="$(httpRoot)core/dlg/dialogs.js" type="text/javascript"></script>
  <script type="text/javascript">
    var current = null;

    function SelectFile(src)
    {
      if (current != null) {
        current.style.color = "WindowText";
        current.style.backgroundColor = "Window";
      }
      src.style.color = "HighlightText";
      src.style.backgroundColor = "Highlight";
      current = src;
    }

    function AcceptFile()
    {
      var url = window.location.search;
      var sId = url.substring(url.indexOf("id=")+3, url.indexOf("&"));
      url = url.substr(url.lastIndexOf("=")+1);
      window.opener.BrowseFileLast = url;
      url += current.lastChild.data;
      var oTarget = window.opener.document.getElementById(sId);
      oTarget.value = "$(uRoot)"+url;
      window.close();
    }
    
    function isFolder(objRow)
    {
      return (objRow.firstChild.src.indexOf("folder.gif") != -1);
    }
    
    function ChangeFolder(strFolder)
    {
      if (strFolder == ".." ) {
        var s = window.location.toString();
        var count = s.lastIndexOf("/", s.length-2)+1;
        if (s.lastIndexOf("=") > count) count = s.lastIndexOf("=")+1;
        window.location = s.substr(0, count);
      } else window.location += strFolder + "/";
    }
    
    function keyPress(event)
    {
      if (iBrowser["Engine"] == "IE") event = window.event;
      switch (event.keyCode) {
        case event.DOM_VK_UP:
          if (current.previousSibling.nodeType != document.TEXT_NODE) SelectFile(current.previousSibling);
          var FileList = document.getElementById("FileList");
          if (current.offsetTop >= FileList.offsetHeight) FileList.scrollTop = current.offsetTop;
          if (current.offsetTop <= FileList.scrollTop) FileList.scrollTop -= current.offsetHeight;
        break;
        case event.DOM_VK_DOWN:
          if (current.nextSibling.nodeType != document.TEXT_NODE) SelectFile(current.nextSibling);
          var FileList = document.getElementById("FileList");
          if (current.offsetTop+current.offsetHeight <= FileList.scrollTop) FileList.scrollTop = current.offsetTop;
          if (current.offsetTop+current.offsetHeight >= FileList.clientHeight) FileList.scrollTop += current.offsetHeight;
        break;
        case event.DOM_VK_HOME:
          var FileList = document.getElementById("FileList");
          SelectFile(FileList.firstChild.nextSibling);
          FileList.scrollTop = 0;
        break;
        case event.DOM_VK_END:
          var FileList = document.getElementById("FileList");
          SelectFile(FileList.lastChild.previousSibling);
          FileList.scrollTop = FileList.scrollHeight - FileList.offsetHeight + current.offsetHeight;
        break;
        case event.DOM_VK_RETURN:
          if (isFolder(current)) ChangeFolder(current.lastChild.data); else AcceptFile();
        break;
        case event.DOM_VK_BACK_SPACE:
          ChangeFolder("..");
        break;
        case event.DOM_VK_ESCAPE:
          window.close();
        break;
      }
      return true;
    }

    function fileListClick(event)
    {
      if (iBrowser["Engine"] == "IE") var obj = window.event.srcElement;
      else var obj = event.target;
      if (obj.nodeType == 3) obj = obj.parentNode;
      SelectFile(obj);
    }
    
    function fileListDblClick(event)
    {
      if (iBrowser["Engine"] == "IE") var obj = window.event.srcElement;
      if (isFolder(current)) ChangeFolder(current.lastChild.data); else AcceptFile();
    }
    
    function afterOpen()
    {
      if (iBrowser["Engine"] != "IE") {
        window.menubar.visible=false;
        window.toolbar.visible=false;
        window.locationbar.visible=false;
        window.personalbar.visible=false;
        window.scrollbars.visible=false;
        window.statusbar.visible=false;    
      }
    }

    function windowOpen()
    {
      var oFirst = document.getElementById("FileList").firstChild;
      if (oFirst.nodeType == 3) oFirst = oFirst.nextSibling;
      SelectFile(oFirst);
    }
    
  </script>
  
  <style type="text/css">
    #FileList {overflow: scroll; height: 400px; font-size: 9pt;}
    select {margin-bottom: 5px;}
    th {text-align: right; white-space: nowrap;}
    td {text-align: left; white-space: nowrap;}
  </style>
</head>
<body onKeyPress="return keyPress(event);" onLoad="windowOpen()">
  <table style="width: 100%; height: 100%; border-collapse: collapse; border-spacing: 0;">
    <tr>
      <td style="text-align: center; padding: 5px; height: 30px;">
        <table>
          <tr>
            <th>Загрузить файл</th>
            <td>
              <form name="Upload" action="$(httpRoot)core/dlg/BrowseFile.php" method="post" enctype="multipart/form-data">
                <input type="file" name="file" size="35"> <input type="submit" value="OK">
              </form>
            </td>
          </tr>
          <tr>
            <th>Создать папку</th>
            <td>
              <form name="CreateFolder" action="$(httpRoot)core/dlg/BrowseFile.php" method="post">
                <input type="text" name="folder" size="35"> <input type="submit" value="Создать">
              </form>
            </td>
          </tr>
        </table>
      </td>
    </tr>
    <tr>
      <td>
        <div class="ListBox" id="FileList" onClick="fileListClick(event);" onDblClick="fileListDblClick(event);">
          $(content)
        </div>
      </td>
    </tr>
    <tr>
      <td style="text-align: center; padding: 5px; height: 50px;">
        <form name="controls" action="">
        <button type="button" onclick="return AcceptFile();">OK</button>&nbsp; 
        <button type="button" onClick="window.close();return false;">Отмена</button>
        </form>
      </td>
    </tr>
  </table>
  <script type="text/javascript">
    afterOpen();
  </script>
</body>
</html>